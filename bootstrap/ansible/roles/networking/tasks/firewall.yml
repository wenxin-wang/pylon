---
- name: Install nftables
  become: true
  ansible.builtin.package:
    name:
      - nftables
    state: present

- set_fact:
    nftable_default_configs:
      - 00-basic.conf
      - 99-persisted.conf

- name: Ensure general files directory
  become: true
  ansible.builtin.file:
    name: "{{ ('/etc/nftables/', item) | path_join | dirname }}"
    state: directory
  loop: "{{ nftables_configs|default(nftable_default_configs) }}"

- name: Copy general files
  become: true
  ansible.builtin.copy:
    src: "firewall/nftables/{{ item }}"
    dest: "/etc/nftables/{{ item }}"
  loop: "{{ nftables_configs|default(nftable_default_configs) }}"
  register: general_files

- name: Render templates
  become: true
  ansible.builtin.template:
    src: "firewall/nftables/{{ item }}.j2"
    dest: "/etc/nftables/{{ item }}"
  loop: "{{ nftables_templated_configs|default([]) }}"
  register: templates

- name: Copy entry config
  become: true
  ansible.builtin.copy:
    src: firewall/nftables.conf
    dest: /etc/nftables.conf
  register: entry_config

- name: Check if specific files exists
  stat:
    path: "{{ specific_host_dir }}/nftables"
  delegate_to: localhost
  run_once: true
  register: specific_dir_check

- name: Copy specific files
  when: specific_dir_check.stat.exists
  become: true
  ansible.builtin.copy:
    src: "{{ specific_host_dir }}/nftables/"
    dest: /etc/nftables
  register: specific_files

- name: Copy apnic-routes-update.sh
  when: clean_internet|default(False)
  become: true
  ansible.builtin.copy:
    src: firewall/apnic-routes-update.sh
    dest: /etc/cron.daily/apnic-routes-update.sh
    mode: 0755
  register: apnic_routes_update_script

- name: Update China DNS
  become: true
  when: clean_internet|default(False) and apnic_routes_update_script.changed
  command: /etc/cron.daily/apnic-routes-update.sh

- name: Add nftable service overrides
  become: true
  block:
    - name: Ensure override directory
      ansible.builtin.copy:
        src: firewall/nftables.service.d/
        dest: /etc/systemd/system/nftables.service.d
      register: nftables_service_override
    - name: Systemd daemon-reload
      when: nftables_service_override.changed
      command: systemctl daemon-reload
    - name: Copy persisted-sets.sh
      become: true
      ansible.builtin.copy:
        src: firewall/nftables/persisted-sets.sh
        dest: /etc/nftables/persisted-sets.sh
        mode: 0755

- name: Enable nftables service
  become: true
  ansible.builtin.service:
    name: nftables
    enabled: true
    state: restarted
  when: >-
    general_files.results|map(attribute='changed') is any or
    templates.results|map(attribute='changed') is any or
    entry_config.changed or
    specific_files.changed
