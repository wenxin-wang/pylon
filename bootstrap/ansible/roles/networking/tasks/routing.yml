---
- name: Allow forwarding ipv4
  when: (allow_forwarding | default(false))
  become: true
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_file: /etc/sysctl.d/100-ipv4-all-forward.conf

- name: Allow forwarding ipv6
  when: (allow_forwarding | default(false))
  become: true
  sysctl:
    name: net.ipv6.conf.all.forwarding
    value: '1'
    sysctl_file: /etc/sysctl.d/100-ipv6-all-forward.conf
    reload: no
    sysctl_set: yes

- name: Use BBR
  when: (allow_forwarding | default(false))
  become: true
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/100-bbr.conf
    reload: no
    sysctl_set: yes
  loop:
    - key: net.core.default_qdisc
      value: fq
    - key: net.ipv4.tcp_congestion_control
      value: bbr
