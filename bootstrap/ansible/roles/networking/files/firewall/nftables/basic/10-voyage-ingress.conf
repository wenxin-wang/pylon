set dns-cn4 {
  type ipv4_addr
  flags interval
  auto-merge
  timeout 12h
}

set dns-cn6 {
  type ipv6_addr
  flags interval
  auto-merge
  timeout 12h
}

set apnic-cn6 {
  type ipv6_addr
  flags interval
  auto-merge
  include "/etc/nftables/sets/anpic-cn6.conf"
}

set apnic-cn4 {
  type ipv4_addr
  flags interval
  auto-merge
  include "/etc/nftables/sets/anpic-cn4.conf"
}

set apnic-cn6 {
  type ipv6_addr
  flags interval
  auto-merge
  include "/etc/nftables/sets/anpic-cn6.conf"
}

set voyage4 {
  type ipv4_addr
  flags interval
  auto-merge
}

set voyage6 {
  type ipv6_addr
  flags interval
  auto-merge
}

set novoyage4 {
  type ipv4_addr
  flags interval
  auto-merge
  elements = { 172.31.0.0/16, 192.168.1.0/24 }
}

set novoyage6 {
  type ipv6_addr
  flags interval
  auto-merge
  elements = { fe80::/10 }
}

chain output-mangle {
  type route hook output priority mangle; policy accept;
  oifname "lo" accept
  ct state new jump voyage_add_connmark
  ct direction vmap { original : jump voyage_restore_mark_original, reply : jump voyage_restore_mark_reply }
  include "/etc/nftables/basic/output-mangle/*.conf"
}

chain prerouting-mangle {
  type filter hook prerouting priority mangle; policy accept;
  ct state new jump voyage_add_connmark
  ct direction vmap { original : jump voyage_restore_mark_original, reply : jump voyage_restore_mark_reply }
  include "/etc/nftables/basic/prerouting-mangle/*.conf"
}

chain voyage_add_connmark {
  ip daddr @voyage4 ct mark set ct mark | 0x00000002 return
  ip6 daddr @voyage6 ct mark set ct mark | 0x00000002 return
  ip daddr @novoyage4 return
  ip6 daddr @novoyage6 return
  ip daddr @apnic-cn4 return
  ip6 daddr @apnic-cn6 return
  ip daddr @dns-cn4 return
  ip6 daddr @dns-cn6 return
  ct mark set ct mark | 0x00000002
}

chain voyage_restore_mark_original {
  ip dscp set 0
  ip6 dscp set 0
  ct mark & 0x00000002 == 0x00000002 ip dscp set cs1
  ct mark & 0x00000002 == 0x00000002 ip6 dscp set cs1
}

chain voyage_restore_mark_reply {
  ip dscp set 0
  ip6 dscp set 0
  ct mark & 0x00000002 == 0x00000002 ip dscp set cs1
  ct mark & 0x00000002 == 0x00000002 ip6 dscp set cs1
  meta mark set meta mark | 0x00000001
}
