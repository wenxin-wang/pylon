chain output-mangle {
  type route hook output priority mangle; policy accept;
  oifname "lo" accept
  ct state new jump voyage_add_connmark
  ct direction reply jump voyage_restore_mark_reply
  include "/etc/nftables/basic/output-mangle/*.conf"
}

chain prerouting-mangle {
  type filter hook prerouting priority mangle; policy accept;
  ct state new jump voyage_add_connmark
  ct direction reply jump voyage_restore_mark_reply
  include "/etc/nftables/basic/prerouting-mangle/*.conf"
}

chain postrouting-mangle {
  type filter hook postrouting priority mangle; policy accept;
  ct state new jump voyage_add_connmark
  ct direction original jump voyage_clear_mark
  include "/etc/nftables/basic/postrouting-mangle/*.conf"
}

chain voyage_add_connmark {
  ip dscp cs1 ct mark set ct mark | 0x00000002 return
  ip6 dscp cs1 ct mark set ct mark | 0x00000002 return
}

chain voyage_restore_mark_reply {
  ct mark & 0x00000002 == 0x00000002 ip dscp set cs1
  ct mark & 0x00000002 == 0x00000002 ip6 dscp set cs1
  meta mark set meta mark | 0x00000001
}

chain voyage_clear_mark {
  ip dscp set 0
  ip6 dscp set 0
}
