---
- name: Update pacman cache
  become: true
  community.general.pacman:
    update_cache: yes

- name: Gather the package facts
  ansible.builtin.package_facts:
    manager: auto

- name: install devel packages for aur manager
  become: true
  ansible.builtin.package:
    name:
      - git
      - base-devel
      - go
    state: present

- block:
    - name: Create temporary build directory for yay
      ansible.builtin.tempfile:
        state: directory
        suffix: yay_build
      register: yay_build_tmp_dir
    - name: checkout yay repo
      ansible.builtin.git:
        repo: 'https://aur.archlinux.org/yay.git'
        dest: '{{ yay_build_tmp_dir.path }}/yay'
        depth: 1
    - name: build yay
      ansible.builtin.command:
        cmd: makepkg -si --noconfirm
        chdir: '{{ yay_build_tmp_dir.path }}/yay'
  always:
    - name: Clean up temporary build directory for yay
      check_mode: no
      ansible.builtin.file:
        path: '{{ yay_build_tmp_dir.path }}'
        state: absent
  when: "'yay' not in ansible_facts.packages"
