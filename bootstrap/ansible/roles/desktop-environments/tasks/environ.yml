---
- name: Ensure /etc/systemd/user-environment-generators
  when: ansible_facts['distribution'] != 'Ubuntu' or ansible_facts['distribution_version'] >= '22.04'
  become: true
  ansible.builtin.file:
    dest: /etc/systemd/user-environment-generators
    state: directory
    mode: 0755

- name: Make systemd user session always use the same environment as our login shell.
  when: ansible_facts['distribution'] != 'Ubuntu' or ansible_facts['distribution_version'] >= '22.04'
  become: true
  ansible.builtin.copy:
    src: etc/systemd/user-environment-generators/70-login-shell-profile.sh
    dest: /etc/systemd/user-environment-generators/70-login-shell-profile.sh
    mode: 0755

# See https://web.archive.org/web/20250804235955/https://yulistic.gitlab.io/2017/12/linux-keymapping-with-udev-hwdb/
- name: copy keyboard config
  become: true
  ansible.builtin.copy:
    src: etc/udev/hwdb.d/61-keyboard-local.hwdb
    dest: /etc/udev/hwdb.d/61-keyboard-local.hwdb
    mode: 0644
  register: keyboard_config

- name: update keyboard config
  when: keyboard_config.changed
  become: true
  ansible.builtin.shell:
    cmd: >-
      sudo systemd-hwdb update && sudo udevadm trigger

- set_fact:
    dotfiles_dir: "{{ specific_host_dir }}/dotfiles"

- name: Find local dot files
  ansible.builtin.find:
    path: "{{ dotfiles_dir }}"
    file_type: file
    recurse: true
  register: dotfiles

- name: Ensure parent directory exists
  ansible.builtin.file:
    path: "~/.{{ item.path | relpath(dotfiles_dir) | dirname }}"
    state: directory
  loop: "{{ dotfiles.files }}"

- name: Check if dst files exist
  ansible.builtin.stat:
    path: "~/.{{ item.path | relpath(dotfiles_dir) }}"
  loop: "{{ dotfiles.files }}"
  register: dotfiles_stat

- name: Link if dst files not exist
  when: not dotfiles_stat.results[idx].stat.exists
  ansible.builtin.file:
    src: "{{ item.path }}"
    dest: "~/.{{ item.path | relpath(dotfiles_dir) }}"
    state: link
  loop: "{{ dotfiles.files }}"
  loop_control:
    index_var: idx

- set_fact:
    public_dotfiles_dir: "{{ (lookup('env', 'HOME'), 'pylon/bootstrap/desktop-environments/dotfiles') | path_join }}"

- name: Find public dot files
  ansible.builtin.find:
    path: "{{ public_dotfiles_dir }}"
    file_type: file
    recurse: true
  register: public_dotfiles

- name: Ensure parent directory exists
  ansible.builtin.file:
    path: "~/.{{ item.path | relpath(public_dotfiles_dir) | dirname }}"
    state: directory
  loop: "{{ public_dotfiles.files }}"

- name: Check if dst files exist
  ansible.builtin.stat:
    path: "~/.{{ item.path | relpath(public_dotfiles_dir) }}"
  loop: "{{ public_dotfiles.files }}"
  register: public_dotfiles_stat

- name: Link if dst files not exist
  when: not public_dotfiles_stat.results[idx].stat.exists
  ansible.builtin.file:
    src: "{{ item.path }}"
    dest: "~/.{{ item.path | relpath(public_dotfiles_dir) }}"
    state: link
  loop: "{{ public_dotfiles.files }}"
  loop_control:
    index_var: idx
