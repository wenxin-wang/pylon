---
- name: DNS
  become: true
  block:
    - name: Install resolvconf
      ansible.builtin.package:
        name:
          - openresolv
        state: present
      register: openresolv_installed
    - name: Uninstall systemd-resolvd
      ansible.builtin.package:
        name:
          - systemd-resolvd
        state: absent
      register: systemd_resolved_removed
    - name: Ensure NetworkManager conf.d folder
      file:
        path: /etc/NetworkManager/conf.d
        state: directory
        mode: 0755
    - name: Network manager use resolvconf
      ansible.builtin.copy:
        content: |
          [main]
          rc-manager=resolvconf
        dest: /etc/NetworkManager/conf.d/rc-manager.conf
      register: nm_config_updated
    - name: Restart NetworkManager
      service:
        name: NetworkManager
        state: restarted
      when: nm_config_updated.changed
    - name: Update resolvconf
      command: resolvconf -u
      when:
        - openresolv_installed.changed or
          systemd_resolved_removed.changed or
          nm_config_updated.changed
